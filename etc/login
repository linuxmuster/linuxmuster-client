# login profile for linuxmuster
# schmitt@lmz-bw.de
#

if test "$USER" != "root"; then

  # Redirects KDE Home to /tmp
  export KDEHOME=/tmp/.kde_${USER}

  # user's desktop has also to be in /tmp
  DESKTOP=/tmp/Desktop_${USER}

  # Redirects access token file for dcopserver to /tmp
  export ICEAUTHORITY=/tmp/${USER}_ICEauthority_${HOSTNAME}

  # Redirects the file "how to access the dcopserver" to /tmp
  export DCOPAUTHORITY=/tmp/${USER}_DCOPserver-${HOSTNAME}_on_${DISPLAY}

  # creating user's temporary dirs
  for i in $KDEHOME $KDEHOME/Autostart $KDEHOME/share $DESKTOP; do
    [[ -L "$i" || -f "$i" ]] && rm $i
    [ -d "$i" ] || mkdir -p $i
    chown $USER $i
    chmod 700 $i
  done
 
  # syncing user's kde settings
  [ -d "$HOME/.kde/share" ] && rsync -a --delete $HOME/.kde/share/ $KDEHOME/share/
 
  # syncing user's kde autostart folder
  [ -d "$HOME/.kde/Autostart" ] && rsync -a --delete $HOME/.kde/Autostart/ $KDEHOME/Autostart/
 
  # syncing user's desktop
  [ -d "$HOME/Desktop" ] && rsync -a --delete $HOME/Desktop/ $DESKTOP/

  # remove .kde folder in user's home and link it to $KDEHOME
  [ -e "$HOME/.kde" ] && rm -rf $HOME/.kde
  ln -s $KDEHOME $HOME/.kde
  chown $USER $HOME/.kde

  # remove desktop folder in user's home and link it to $DESKTOP
  [ -e "$HOME/Desktop" ] && rm -rf $HOME/Desktop
  ln -s $DESKTOP $HOME/Desktop
  chown $USER $HOME/Desktop

fi
